<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <title>Frazo Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        :root {
            --bg: #0f172a;
            --bg-alt: #020617;
            --card: #020617;
            --primary: #38bdf8;
            --primary-soft: rgba(56, 189, 248, 0.15);
            --text: #e5e7eb;
            --text-soft: #9ca3af;
            --user-bubble: #0ea5e9;
            --bot-bubble: #111827;
            --border: #1f2937;
            --danger: #f87171;
            --radius: 18px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top, #1f2937, #020617);
            color: var(--text);
            display: flex;
            justify-content: center;
            align-items: stretch;
            min-height: 100vh;
        }

        .app-wrapper {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 920px;
            margin: 0 auto;
            padding: 12px;
        }

        .card {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: linear-gradient(145deg, var(--card), #020617);
            border-radius: 24px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            box-shadow: 0 22px 60px rgba(15, 23, 42, 0.8);
            overflow: hidden;
        }

        .header {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(15, 23, 42, 0.9);
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            background: radial-gradient(circle at left, rgba(56, 189, 248, 0.12), transparent);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-dot {
            width: 32px;
            height: 32px;
            border-radius: 999px;
            background: radial-gradient(circle at 30% 0%, #a855f7, #0ea5e9);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            color: white;
            box-shadow: 0 0 18px rgba(56, 189, 248, 0.6);
        }

        .title-block h1 {
            margin: 0;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .title-block h1 span {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            color: var(--text-soft);
        }

        .title-block p {
            margin: 2px 0 0 0;
            color: var(--text-soft);
            font-size: 12px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 11px;
            color: var(--text-soft);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: #22c55e;
            box-shadow: 0 0 12px rgba(34, 197, 94, 0.9);
        }

        .api-url {
            font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco,
                Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 11px;
            padding: 4px 6px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            background-color: rgba(15, 23, 42, 0.8);
            color: var(--text-soft);
            max-width: 230px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 12px 16px;
            gap: 10px;
            overflow: hidden;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding-right: 4px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            scroll-behavior: smooth;
        }

        .message-row {
            display: flex;
            margin-top: 4px;
        }

        .message-row.user {
            justify-content: flex-end;
        }

        .message-row.bot {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: min(80%, 640px);
            padding: 10px 12px;
            border-radius: var(--radius);
            font-size: 14px;
            line-height: 1.45;
            border: 1px solid transparent;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .message-bubble.user {
            background: linear-gradient(135deg, var(--user-bubble), #0369a1);
            color: white;
            border-bottom-right-radius: 4px;
            border-color: rgba(15, 23, 42, 0.4);
        }

        .message-bubble.bot {
            background: radial-gradient(circle at top left, var(--primary-soft), var(--bot-bubble));
            color: var(--text);
            border-bottom-left-radius: 4px;
            border-color: rgba(30, 64, 175, 0.6);
        }

        .message-meta {
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
            font-size: 10px;
            color: var(--text-soft);
        }

        .details-toggle {
            margin-top: 6px;
            font-size: 11px;
            color: var(--primary);
            cursor: pointer;
            text-decoration: underline;
        }

        .details-json {
            margin-top: 6px;
            font-size: 11px;
            font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco,
                Consolas, "Liberation Mono", "Courier New", monospace;
            background-color: #020617;
            border-radius: 10px;
            padding: 8px;
            border: 1px solid var(--border);
            max-height: 220px;
            overflow-y: auto;
            color: var(--text-soft);
        }

        .input-area {
            border-top: 1px solid var(--border);
            padding: 10px 14px 14px 14px;
            background: linear-gradient(to top, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.85));
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .input-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        textarea {
            flex: 1;
            resize: none;
            min-height: 42px;
            max-height: 120px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background-color: rgba(15, 23, 42, 0.97);
            color: var(--text);
            padding: 10px 14px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.15s ease, box-shadow 0.15s ease, border-radius 0.15s ease;
        }

        textarea:focus {
            border-color: var(--primary);
            border-radius: 18px;
            box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.5);
        }

        button {
            border: none;
            border-radius: 999px;
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, var(--primary), #22d3ee);
            color: #0b1120;
            box-shadow: 0 12px 24px rgba(56, 189, 248, 0.45);
            transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.12s ease;
            white-space: nowrap;
        }

        button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 16px 32px rgba(56, 189, 248, 0.6);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 10px 18px rgba(56, 189, 248, 0.5);
        }

        button:disabled {
            opacity: 0.6;
            cursor: default;
            box-shadow: none;
        }

        .hint-row {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-soft);
        }

        .error-text {
            color: var(--danger);
        }

        /* Mobile tweaks */
        @media (max-width: 640px) {
            .card {
                border-radius: 18px;
            }

            .header {
                padding: 10px 12px;
            }

            .chat-container {
                padding: 10px 10px;
            }

            .message-bubble {
                max-width: 100%;
            }

            .api-url {
                max-width: 180px;
            }
        }
    </style>
</head>

<body>
    <div class="app-wrapper">
        <div class="card">
            <div class="header">
                <div class="header-left">
                    <div class="logo-dot">F</div>
                    <div class="title-block">
                        <h1>
                            Frazo Chat
                            <span>NLU + BigQuery + LLM</span>
                        </h1>
                        <p>FaÃ§a perguntas sobre filmes (ano, elenco, gÃªnero, etc.).</p>
                    </div>
                </div>
                <div class="header-right">
                    <div class="status-dot"></div>
                    <span id="status-text">Conectado ao backend</span>
                    <div class="api-url" title="URL da API">
                        <span id="api-url-label">http://localhost:8000/chat</span>
                    </div>
                </div>
            </div>

            <div class="chat-container">
                <div id="messages" class="messages"></div>

                <div class="input-area">
                    <div class="input-row">
                        <textarea id="input" rows="1"
                            placeholder="Pergunte algo como 'Filmes de 2022', 'Elenco de Matrix', 'MÃ©dia de nota para filmes de aÃ§Ã£o'..."></textarea>
                        <button id="send-btn">
                            <span>Enviar</span>
                            <span>â®ž</span>
                        </button>
                    </div>
                    <div class="hint-row">
                        <span>Enter para enviar â€¢ Shift+Enter para quebrar linha</span>
                        <span id="error-label" class="error-text"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================
        // CONFIGURAÃ‡ÃƒO
        // ==========================
        const API_BASE_URL = "__API_URL_PLACEHOLDER__";
        const CHAT_ENDPOINT = "/chat";

        // ==========================
        // ELEMENTOS
        // ==========================
        const messagesEl = document.getElementById("messages");
        const inputEl = document.getElementById("input");
        const sendBtn = document.getElementById("send-btn");
        const statusTextEl = document.getElementById("status-text");
        const apiUrlLabelEl = document.getElementById("api-url-label");
        const errorLabelEl = document.getElementById("error-label");

        apiUrlLabelEl.textContent = API_BASE_URL + CHAT_ENDPOINT;

        let isSending = false;

        // ==========================
        // HELPERS UI
        // ==========================

        function appendMessage(role, text, meta = {}, structuredData = null) {
            const row = document.createElement("div");
            row.className = `message-row ${role}`;

            const bubble = document.createElement("div");
            bubble.className = `message-bubble ${role}`;
            bubble.textContent = text;

            row.appendChild(bubble);

            // Metadados (sÃ³ pro bot)
            if (role === "bot") {
                const metaDiv = document.createElement("div");
                metaDiv.className = "message-meta";

                const leftMeta = document.createElement("span");
                leftMeta.textContent = meta.label || "Resposta";

                const rightMeta = document.createElement("span");
                rightMeta.textContent = meta.timestamp || new Date().toLocaleTimeString("pt-BR").slice(0, 5);

                metaDiv.appendChild(leftMeta);
                metaDiv.appendChild(rightMeta);
                bubble.appendChild(metaDiv);

                if (structuredData) {
                    const toggle = document.createElement("div");
                    toggle.className = "details-toggle";
                    toggle.textContent = "Ver detalhes estruturados";
                    bubble.appendChild(toggle);

                    const details = document.createElement("pre");
                    details.className = "details-json";
                    details.textContent = JSON.stringify(structuredData, null, 2);
                    details.style.display = "none";
                    bubble.appendChild(details);

                    toggle.addEventListener("click", () => {
                        const isHidden = details.style.display === "none";
                        details.style.display = isHidden ? "block" : "none";
                        toggle.textContent = isHidden ? "Ocultar detalhes estruturados" : "Ver detalhes estruturados";
                    });
                }
            }

            messagesEl.appendChild(row);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function setSendingState(sending) {
            isSending = sending;
            sendBtn.disabled = sending;
            errorLabelEl.textContent = "";
            if (sending) {
                statusTextEl.textContent = "Enviando pergunta...";
            } else {
                statusTextEl.textContent = "Conectado ao backend";
            }
        }

        function setError(msg) {
            errorLabelEl.textContent = msg || "";
            if (msg) {
                statusTextEl.textContent = "Erro";
            }
        }

        // ==========================
        // LÃ“GICA DE ENVIO
        // ==========================

        async function sendMessage() {
            const question = inputEl.value.trim();
            if (!question || isSending) return;

            // Adiciona mensagem do usuÃ¡rio
            appendMessage("user", question);
            inputEl.value = "";
            setSendingState(true);

            try {
                // A sua API espera um POST com body = JSON.stringify("texto")
                const res = await fetch(API_BASE_URL + CHAT_ENDPOINT, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(question),
                });

                if (!res.ok) {
                    const text = await res.text();
                    console.error("Erro HTTP:", res.status, text);
                    setError(`Erro ${res.status}. Veja o console para detalhes.`);
                    appendMessage(
                        "bot",
                        "Houve um erro ao consultar o backend. Tente novamente.",
                        { label: "Erro" }
                    );
                    return;
                }

                const data = await res.json();
                console.log("Resposta backend:", data);

                const llm_answer =
                    (typeof data.llm_answer === "string" && data.llm_answer.trim()) ||
                    data.dialog?.answer ||
                    "NÃ£o consegui gerar uma resposta amigÃ¡vel, mas veja os dados estruturados.";

                const structured = {
                    nlu: data.nlu ?? null,
                    dialog: data.dialog ?? null,
                    full_response: data,
                };

                appendMessage(
                    "bot",
                    llm_answer,
                    { label: "Frazo LLM" },
                    structured
                );
            } catch (err) {
                console.error(err);
                setError("Falha de rede ou CORS.");
                appendMessage(
                    "bot",
                    "NÃ£o consegui falar com a API (falha de rede ou CORS).",
                    { label: "Erro" }
                );
            } finally {
                setSendingState(false);
            }
        }

        // ==========================
        // EVENTOS
        // ==========================

        sendBtn.addEventListener("click", sendMessage);

        inputEl.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Mensagem inicial
        appendMessage(
            "bot",
            "OlÃ¡! Sou a interface do Frazo. Pergunte sobre filmes, anos, elencos, gÃªneros, notas ou votos que eu respondo usando NLU + BigQuery + LLM. ðŸ™‚",
            { label: "Sistema" }
        );
    </script>
</body>

</html>